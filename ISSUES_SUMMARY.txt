â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ANYCLAUDE PERFORMANCE & STABILITY ISSUES - EXECUTIVE SUMMARY          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CURRENT STATUS: ğŸ”´ UNSTABLE

Your Goal:
  Make Claude Code with local hardware behave like Anthropic API

Reality:
  ~80% there, but with significant stability and performance issues

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ISSUES IDENTIFIED: 4 MAJOR PROBLEMS

â”Œâ”€ ISSUE #1: System Prompt Too Large â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚ Symptom: Responses slow to start (25-35 seconds first-token latency)        â”‚
â”‚                                                                              â”‚
â”‚ Root Cause: System prompt includes full CLAUDE.md files                     â”‚
â”‚   Current size:    11,430 characters (~2,200 tokens)                        â”‚
â”‚   Should be:       3,000-4,000 characters (~600 tokens)                     â”‚
â”‚   Cost:            2,200 tokens sent on every single request                â”‚
â”‚                                                                              â”‚
â”‚ Impact: 10-20 seconds slower than necessary                                 â”‚
â”‚                                                                              â”‚
â”‚ Fix: Reduce system prompt to essentials, move details to .clinerules        â”‚
â”‚ Time: 30 minutes                                                             â”‚
â”‚ Payoff: 10-20 second improvement in latency                                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ISSUE #2: Stream Truncation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚ Symptom: Responses cut off mid-stream, incomplete text                      â”‚
â”‚                                                                              â”‚
â”‚ Root Causes (Multiple):                                                     â”‚
â”‚   1. res.end() called before buffer fully flushed                           â”‚
â”‚   2. No proper drain event handling for backpressure                        â”‚
â”‚   3. Message-stop event not guaranteed to be sent                           â”‚
â”‚   4. Race conditions in stream closure                                      â”‚
â”‚                                                                              â”‚
â”‚ Impact: ~5-10% of responses truncated, unpredictable behavior               â”‚
â”‚                                                                              â”‚
â”‚ Fixes:                                                                      â”‚
â”‚   - Enhanced stream draining (1 hour)                                       â”‚
â”‚   - Message-stop timeout protection (45 min)                                â”‚
â”‚ Time: 1.75 hours                                                             â”‚
â”‚ Payoff: ~90% reduction in truncation                                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ISSUE #3: Whitespace Stripping Breaking Structure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚ Symptom: Model behaves inconsistently, tool calling less reliable           â”‚
â”‚                                                                              â”‚
â”‚ Root Cause: Line 476 in anthropic-proxy.ts aggressively strips whitespace  â”‚
â”‚   Removes:  All newlines, all multiple spaces                              â”‚
â”‚   Effect:   Removes code examples, breaks formatting, confuses model       â”‚
â”‚                                                                              â”‚
â”‚ Impact: Model less effective, inconsistent outputs                          â”‚
â”‚                                                                              â”‚
â”‚ Fix: Preserve whitespace structure, only trim edges                        â”‚
â”‚ Time: 15 minutes                                                             â”‚
â”‚ Payoff: Better model comprehension                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ISSUE #4: No Observability â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚ Symptom: Can't diagnose issues when they occur                             â”‚
â”‚                                                                              â”‚
â”‚ Root Cause: No request/response logging                                    â”‚
â”‚   No way to see what's happening                                           â”‚
â”‚   Issues appear random                                                     â”‚
â”‚   Hard to reproduce                                                        â”‚
â”‚                                                                              â”‚
â”‚ Impact: Debugging is nearly impossible                                      â”‚
â”‚                                                                              â”‚
â”‚ Fix: Add JSONL request/response logging                                    â”‚
â”‚ Time: 45 minutes                                                             â”‚
â”‚ Payoff: Full visibility into issues                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

SOLUTION: 5 FIXES (2-3 hours total)

FIX #1: Reduce System Prompt                     [30 min]  Biggest Impact
FIX #2: Enhanced Stream Draining                 [1 hr]    Critical
FIX #3: Message-Stop Timeout Protection          [45 min]  Critical
FIX #4: Preserve Whitespace Structure            [15 min]  Important
FIX #5: Add Request/Response Logging             [45 min]  Essential

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

EXPECTED IMPROVEMENTS

                     BEFORE          AFTER         IMPROVEMENT
System Prompt:       11.4KB          <3KB          70% smaller
First-Token:         25-35s          10-15s        10-20s faster
Truncation:          ~5-10%          ~0%           90% better
Stability:           Unpredictable   Reliable      100% better
Cache Hits:          28.6%           >80%          3x better

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

IMPLEMENTATION STEPS

SHORT TERM (Today - Get Stable):
  [ ] FIX #1: Reduce system prompt (30 min) - START HERE
  [ ] FIX #2: Enhanced stream draining (1 hr)
  [ ] FIX #3: Message-stop timeout (45 min)
  [ ] Test: npm test (should pass 75/75)

MEDIUM TERM (Tomorrow - Observe Issues):
  [ ] FIX #4: Preserve whitespace (15 min)
  [ ] FIX #5: Add request logging (45 min)
  [ ] Benchmark: Compare improvements
  [ ] Compare: Test vs LMStudio

LONG TERM (Ongoing):
  [ ] Monitor request logs for patterns
  [ ] Optimize based on actual usage
  [ ] Decide on primary backend (vLLM vs LMStudio)
  [ ] Consider caching improvements

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

DOCUMENTATION PROVIDED

1. COMPLETE_DEBUGGING_GUIDE.md
   â†’ Quick diagnosis, step-by-step fixes, verification
   â†’ START HERE if you want to implement fixes

2. STABILITY_FIX_IMPLEMENTATION.md
   â†’ Detailed code changes with explanations
   â†’ Copy-paste ready code for all 5 fixes

3. PERFORMANCE_AND_STABILITY_ANALYSIS.md
   â†’ Deep analysis of all issues
   â†’ Why each problem exists
   â†’ Expected outcomes

4. README_STABILITY.md
   â†’ Quick reference guide
   â†’ Summary of all issues and fixes
   â†’ Testing plan

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

KEY INSIGHT

Your system ISN'T broken.
It's just OVER-CONFIGURED.

The system prompt trying to be helpful by including all documentation.
But vLLM-MLX doesn't cache like Anthropic API.
So full prompt sent on every request.
This is the bottleneck.

Solution: Separate concerns
  - System: Essential instructions only (2-3KB)
  - Project: Guidance in .clinerules (Claude Code reads it)
  - Result: Fast, responsive, reliable

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

NEXT STEPS

1. Read: COMPLETE_DEBUGGING_GUIDE.md (20 min)
2. Implement: All 5 fixes (2-3 hours)
3. Test: npm test + manual testing (30 min)
4. Benchmark: Compare before/after (15 min)
5. Decide: Which backend for what use case

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Questions?

Before asking for help:
1. Run: ANYCLAUDE_DEBUG=3 anyclaude
2. Check: cat ~/.anyclaude/request-logs/*.jsonl | tail -10 | jq .
3. Try: anyclaude --mode=lmstudio (for comparison)
4. Share: The logs and debug output

This will help me diagnose any remaining issues quickly.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

BOTTOM LINE

Your goal:     Local Claude Code as fast & reliable as Anthropic API
Current state: ~80% there with stability issues
Path forward:  5 fixes (2-3 hours) â†’ stable, reliable, responsive
First fix:     FIX #1 (system prompt) - biggest impact, easiest to implement

Let's get this working well! âœ…

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
