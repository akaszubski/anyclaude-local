# Checkpoint: anthropic-proxy-cluster Tests Complete

## Status: Tests Written (TDD Specification Phase)

**Date**: 2025-12-27
**Phase**: Test-first development (specification complete)
**Tests**: 36 tests, all passing
**File**: /Users/andrewkaszubski/Dev/anyclaude/tests/unit/anthropic-proxy-cluster.test.ts

## Test Coverage

### Part 1: computePromptHash() - 12 tests

- Stable SHA-256 hash generation
- Different hashes for different prompts
- Different hashes for different tools
- Empty/undefined tools handling
- Order-sensitive hashing (cache affinity)
- Long prompts (100k characters)
- Complex tool schemas
- Special characters and Unicode
- Deterministic behavior (100 iterations)

### Part 2: Cluster Routing - 19 tests

**selectNode Integration (5 tests)**:

- Calls ClusterManager.selectNode() with computed hashes
- Uses X-Session-Id header for session stickiness
- Generates UUID when session ID missing
- Gets provider from ClusterManager.getNodeProvider()
- Uses node-specific provider for streamText

**503 Error Handling (4 tests)**:

- Returns 503 when no healthy nodes
- Includes Retry-After header
- Returns cluster_unavailable error type
- Doesn't call streamText when cluster unavailable

**Failure Recording (3 tests)**:

- Calls recordNodeFailure on stream errors
- Records failure with error details
- Skips recording for mid-stream failures

**Success Recording (3 tests)**:

- Calls recordNodeSuccess on completion
- Records latency in milliseconds
- Only records after full stream consumption

**Edge Cases (4 tests)**:

- Handles ClusterManager not initialized
- Handles getNodeProvider returning null
- Handles concurrent requests
- Handles session persistence

### Part 3: Regression Tests - 4 tests

- lmstudio mode doesn't call ClusterManager
- openrouter mode doesn't call ClusterManager
- claude mode doesn't call ClusterManager
- Default provider used in non-cluster modes

### Summary Test - 1 test

- Implementation checklist validation

## Implementation Checklist

When implementing cluster routing in src/anthropic-proxy.ts:

- [ ] Add computePromptHash(systemPrompt: string, tools?: any[]): string helper
- [ ] Add generateSessionId(): string helper (UUID v4)
- [ ] Add cluster routing logic when mode === 'mlx-cluster'
- [ ] Extract session ID from X-Session-Id request header
- [ ] Call ClusterManager.selectNode(systemPromptHash, toolsHash, sessionId)
- [ ] Get node-specific provider via ClusterManager.getNodeProvider(nodeId)
- [ ] Return 503 with Retry-After when selectNode() returns null
- [ ] Record failures via ClusterManager.recordNodeFailure(nodeId, error)
- [ ] Record successes via ClusterManager.recordNodeSuccess(nodeId, latencyMs)
- [ ] Ensure non-cluster modes (lmstudio, openrouter, claude) unchanged

## Key Design Decisions

1. **Hash Computation**: SHA-256 for stable cache affinity
   - Includes system prompt + tools (order-sensitive)
   - 64-character hex string output

2. **Session Stickiness**: UUID v4 for session IDs
   - Extracted from X-Session-Id header if present
   - Auto-generated if missing

3. **Error Handling**: 503 for cluster unavailability
   - Retry-After: 10 header
   - cluster_unavailable error type
   - No retry for mid-stream failures

4. **Metrics Recording**: Track per-node performance
   - Success: record latency in milliseconds
   - Failure: record error details
   - Only after full stream consumption

## Next Steps

1. **Implement in anthropic-proxy.ts** (developer-master agent)
   - Location: Around lines 460-480 (streamText call)
   - Add imports: import { getClusterManager } from './cluster/cluster-manager'
   - Add helper functions at top of file

2. **Integration test** (test-master agent)
   - Create E2E test with real ClusterManager
   - Test actual HTTP proxy behavior
   - Verify headers, responses, metrics

3. **Documentation** (docs-master agent)
   - Update CLAUDE.md with cluster routing details
   - Add troubleshooting section
   - Document X-Session-Id header usage

## Test Run Results

Test Suites: 1 passed, 1 total
Tests: 36 passed, 36 total
Time: 1.274 s

All tests in computePromptHash(), cluster routing, regression, and summary sections passed.

## Notes

- Tests currently PASS because they test helper functions and mock interactions
- Real integration will happen when anthropic-proxy.ts is modified
- This test suite serves as a specification for expected behavior
- TDD approach: Write tests first, implement second
