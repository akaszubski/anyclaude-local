#!/bin/bash
# AnyClaude - Unified Launcher (Simplified)
# Single entry point that manages everything
# Usage: ./anyclaude                      # Start with MLX-Omni (recommended - HuggingFace models)
#        ./anyclaude mlx-lm               # Start with MLX-LM (local model paths)
#        ./anyclaude --mode=vllm-mlx      # Start with vLLM-MLX (supports --mode= syntax)
#        ./anyclaude mlx-lm /path/to/model # Start with MLX-LM using specific model

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load configuration from .anyclauderc (if it exists)
# Order of precedence: project .anyclauderc → home ~/.anyclauderc → defaults
load_config() {
  # Check project directory first
  if [ -f "$SCRIPT_DIR/.anyclauderc" ]; then
    # shellcheck disable=SC1090
    source "$SCRIPT_DIR/.anyclauderc"
    echo "[Config] Loaded .anyclauderc from project directory" >&2
  fi

  # Then check home directory (overrides project config)
  if [ -f "$HOME/.anyclauderc" ]; then
    # shellcheck disable=SC1090
    source "$HOME/.anyclauderc"
    echo "[Config] Loaded .anyclauderc from home directory" >&2
  fi

  # Environment variables override config files (highest priority)
  # These are already set in the environment if user exports them
}

load_config

# Command line args override everything
# If first arg starts with --, pass through to Node.js binary (new --mode= syntax)
if [[ "$1" == --* ]]; then
  # Use the Node.js based binary instead of shell scripts
  exec node "$SCRIPT_DIR/dist/main.js" "$@"
fi

# Otherwise, support legacy positional argument syntax
MODE=${1:-${ANYCLAUDE_MODE:-mlx-omni-local}}  # Default: MLX-Omni-Local (KV cache + local models)
REMAINING_ARGS=("${@:2}")

# Cleanup
cleanup() {
  pkill -f "mlx-omni-server\|mlx_lm\|bun.*main\|node.*main" 2>/dev/null || true
  rm -f /tmp/anyclaude-*.pids 2>/dev/null || true
}

# Show help
show_help() {
  echo "AnyClaude - Local Claude Code with LMStudio, MLX, or vLLM"
  echo ""
  echo "Usage: ./anyclaude [MODE] [OPTIONS]  or  ./anyclaude --mode=<backend> [OPTIONS]"
  echo ""
  echo "Modes (Legacy Positional):"
  echo "  (default)              Start MLX-Omni (RECOMMENDED for HuggingFace models)"
  echo "  mlx-omni               Same as default - loads HuggingFace model IDs"
  echo "  mlx-lm                 Use MLX-LM - loads local model paths OR HuggingFace IDs"
  echo "  help                   Show this message"
  echo ""
  echo "Modes (New --mode= Flag Syntax):"
  echo "  --mode=lmstudio        Use LMStudio (default in config)"
  echo "  --mode=mlx-lm          Use MLX-LM (MLX on CPU/GPU)"
  echo "  --mode=vllm-mlx        Use vLLM-MLX (high-performance MLX)"
  echo "  --mode=claude          Use real Anthropic API (requires ANTHROPIC_API_KEY)"
  echo ""
  echo "Examples:"
  echo "  ./anyclaude                                # Start with default mode"
  echo "  ./anyclaude mlx-lm                         # Start with MLX-LM"
  echo "  ./anyclaude --mode=lmstudio                # Start with LMStudio"
  echo "  ./anyclaude --mode=vllm-mlx                # Start with vLLM-MLX"
  echo "  ./anyclaude --mode=claude                  # Start with Anthropic API"
  echo "  ./anyclaude help                           # Show this message"
  echo ""
  echo "Configuration:"
  echo "  Create .anyclauderc.json in project directory to configure backends"
  echo "  Example: { \"backend\": \"lmstudio\", \"backends\": { \"lmstudio\": { \"baseUrl\": \"...\" } } }"
  echo ""
  echo "Environment variables:"
  echo "  ANYCLAUDE_DEBUG          Debug level (0=none, 1=basic, 2=verbose, 3=trace)"
  echo "  ANYCLAUDE_NO_AUTO_LAUNCH Disable automatic backend server startup"
  echo "  LMSTUDIO_URL             LMStudio API URL (default: http://localhost:1234/v1)"
  echo "  VLLM_MLX_URL             vLLM-MLX API URL (default: http://localhost:8081/v1)"
  echo ""
}

# Main
trap cleanup EXIT

case "$MODE" in
  help)
    show_help
    exit 0
    ;;
  mlx-omni-local)
    # MLX-Omni with local model pre-loading (RECOMMENDED - KV cache + local models)
    if [ ! -f "$SCRIPT_DIR/anyclaude-omni-local" ]; then
      echo "Error: anyclaude-omni-local launcher not found!"
      exit 1
    fi
    exec "$SCRIPT_DIR/anyclaude-omni-local"
    ;;
  mlx-omni|"")
    # For mlx-omni, we need to verify the script exists first
    if [ ! -f "$SCRIPT_DIR/anyclaude-mlx-omni" ]; then
      echo "Error: anyclaude-mlx-omni launcher not found!"
      exit 1
    fi
    exec "$SCRIPT_DIR/anyclaude-mlx-omni"
    ;;
  mlx-lm)
    # For mlx-lm, we need to verify the script exists first
    if [ ! -f "$SCRIPT_DIR/anyclaude-mlx-lm" ]; then
      echo "Error: anyclaude-mlx-lm launcher not found!"
      exit 1
    fi
    # If a model path was provided as argument, use it
    if [ -n "$2" ]; then
      export MLX_MODEL="$2"
    fi
    exec "$SCRIPT_DIR/anyclaude-mlx-lm"
    ;;
  *)
    echo "Unknown mode: $MODE"
    echo "Run './anyclaude help' for usage"
    exit 1
    ;;
esac
