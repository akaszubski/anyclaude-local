#!/bin/bash
# AnyClaude - Unified Launcher (Simplified)
# Single entry point that manages everything
# Usage: ./anyclaude                      # Start with MLX-Omni (recommended - HuggingFace models)
#        ./anyclaude mlx-lm               # Start with MLX-LM (local model paths)
#        ./anyclaude mlx-lm /path/to/model # Start with MLX-LM using specific model

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load configuration from .anyclauderc (if it exists)
# Order of precedence: project .anyclauderc → home ~/.anyclauderc → defaults
load_config() {
  # Check project directory first
  if [ -f "$SCRIPT_DIR/.anyclauderc" ]; then
    # shellcheck disable=SC1090
    source "$SCRIPT_DIR/.anyclauderc"
    echo "[Config] Loaded .anyclauderc from project directory" >&2
  fi

  # Then check home directory (overrides project config)
  if [ -f "$HOME/.anyclauderc" ]; then
    # shellcheck disable=SC1090
    source "$HOME/.anyclauderc"
    echo "[Config] Loaded .anyclauderc from home directory" >&2
  fi

  # Environment variables override config files (highest priority)
  # These are already set in the environment if user exports them
}

load_config

# Command line args override everything
MODE=${1:-${ANYCLAUDE_MODE:-mlx-omni}}  # Default: MLX-Omni (recommended)

# Cleanup
cleanup() {
  pkill -f "mlx-omni-server\|mlx_lm\|bun.*main\|node.*main" 2>/dev/null || true
  rm -f /tmp/anyclaude-*.pids 2>/dev/null || true
}

# Show help
show_help() {
  echo "AnyClaude - Local Claude Code with MLX"
  echo ""
  echo "Usage: ./anyclaude [MODE] [OPTIONS]"
  echo ""
  echo "Modes:"
  echo "  (default)              Start MLX-Omni (RECOMMENDED for HuggingFace models)"
  echo "  mlx-omni               Same as default - loads HuggingFace model IDs"
  echo "  mlx-lm                 Use MLX-LM - loads local model paths OR HuggingFace IDs"
  echo "  help                   Show this message"
  echo ""
  echo "Examples:"
  echo "  ./anyclaude                                # Start with MLX-Omni (default)"
  echo "  ./anyclaude mlx-lm                         # Start with MLX-LM (HuggingFace ID)"
  echo "  ./anyclaude mlx-lm /path/to/local/model    # Start with MLX-LM (local model)"
  echo "  ./anyclaude help                           # Show this message"
  echo ""
  echo "Environment variables (all modes):"
  echo "  MLX_MODEL        HuggingFace model ID or local path"
  echo "  ANYCLAUDE_DEBUG  Debug level (0=none, 1=basic, 2=verbose, 3=trace)"
  echo "  VENV_PATH        Path to MLX venv (default: ~/.venv-mlx)"
  echo ""
  echo "Key Differences:"
  echo "  MLX-Omni:  ✓ HuggingFace models only (mlx-community/...)"
  echo "             ✓ Native Anthropic API format"
  echo "             ✓ Full tool support and streaming"
  echo ""
  echo "  MLX-LM:    ✓ Local model paths (filesystem)"
  echo "             ✓ HuggingFace model IDs (auto-downloads)"
  echo "             ✓ OpenAI-compatible API format"
  echo ""
  echo "To use your local Qwen3-Coder-30B model:"
  echo "  export MLX_MODEL=\"/Users/akaszubski/ai-tools/lmstudio/lmstudio-community/Qwen3-Coder-30B-A3B-Instruct-MLX-4bit\""
  echo "  ./anyclaude mlx-lm"
}

# Main
trap cleanup EXIT

case "$MODE" in
  help)
    show_help
    exit 0
    ;;
  mlx-omni|"")
    # For mlx-omni, we need to verify the script exists first
    if [ ! -f "$SCRIPT_DIR/anyclaude-mlx-omni" ]; then
      echo "Error: anyclaude-mlx-omni launcher not found!"
      exit 1
    fi
    exec "$SCRIPT_DIR/anyclaude-mlx-omni"
    ;;
  mlx-lm)
    # For mlx-lm, we need to verify the script exists first
    if [ ! -f "$SCRIPT_DIR/anyclaude-mlx-lm" ]; then
      echo "Error: anyclaude-mlx-lm launcher not found!"
      exit 1
    fi
    # If a model path was provided as argument, use it
    if [ -n "$2" ]; then
      export MLX_MODEL="$2"
    fi
    exec "$SCRIPT_DIR/anyclaude-mlx-lm"
    ;;
  *)
    echo "Unknown mode: $MODE"
    echo "Run './anyclaude help' for usage"
    exit 1
    ;;
esac
