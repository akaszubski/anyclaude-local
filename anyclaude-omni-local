#!/bin/bash
# AnyClaude + MLX-Omni with Local Model Loading
# This script loads a local model into MLX-Omni, then launches AnyClaude with KV cache
#
# IMPORTANT: MLX-Omni-Server does NOT accept --model parameter
# Instead, it loads whatever model is loaded in its environment
# This script uses the MLX_LM Python library to pre-load the model, then starts MLX-Omni

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load configuration from .anyclauderc (if it exists)
load_config() {
  if [ -f "$SCRIPT_DIR/.anyclauderc" ]; then
    source "$SCRIPT_DIR/.anyclauderc"
  fi

  if [ -f "$HOME/.anyclauderc" ]; then
    source "$HOME/.anyclauderc"
  fi
}

load_config

# Apply defaults
MLX_OMNI_PORT=${MLX_OMNI_PORT:-8080}
MLX_MODEL=${MLX_MODEL:-"mlx-community/Qwen2.5-3B-Instruct-4bit"}
ANYCLAUDE_DEBUG=${ANYCLAUDE_DEBUG:-0}
PROXY_ONLY=${PROXY_ONLY:-false}
VENV_PATH=${VENV_PATH:-"$HOME/.venv-mlx"}

# State files
PIDS_FILE="/tmp/anyclaude-omni-local.pids"
LOG_DIR="/tmp/anyclaude-omni-local-logs"
mkdir -p "$LOG_DIR"

# Cleanup function
cleanup() {
  echo -e "\n${YELLOW}[AnyClaude]${NC} Shutting down..."

  if [ -f "$PIDS_FILE" ]; then
    while IFS= read -r pid; do
      if kill -0 "$pid" 2>/dev/null; then
        echo -e "${YELLOW}[AnyClaude]${NC} Stopping process $pid..."
        kill "$pid" 2>/dev/null || true
        sleep 1
        kill -9 "$pid" 2>/dev/null || true
      fi
    done < "$PIDS_FILE"
    rm "$PIDS_FILE"
  fi

  echo -e "${GREEN}[AnyClaude]${NC} Shutdown complete"
  exit 0
}

trap cleanup SIGINT SIGTERM EXIT

# Check virtual environment
check_venv_exists() {
  if [ ! -d "$VENV_PATH" ]; then
    echo -e "${RED}Error: Virtual environment not found at $VENV_PATH${NC}"
    echo "Create it with: python3 -m venv $VENV_PATH"
    exit 1
  fi
}

# Note: Model loading is handled by MLX-Omni-Server directly
# MLX-Omni loads the model from the HF_HOME cache or downloads it
skip_model_loading() {
  # This is now a no-op since MLX-Omni handles model loading
  # Just for clarity in the flow
  return 0
}

# Start MLX-Omni-Server
start_mlx_omni() {
  echo ""
  echo -e "${BLUE}[MLX-Omni]${NC} Starting MLX-Omni-Server on port $MLX_OMNI_PORT..."
  echo -e "${BLUE}[MLX-Omni]${NC} Using model: $MLX_MODEL"

  /Users/akaszubski/.local/bin/mlx-omni-server \
    --port "$MLX_OMNI_PORT" \
    > "$LOG_DIR/mlx-omni-server.log" 2>&1 &

  MLX_OMNI_PID=$!
  echo "$MLX_OMNI_PID" >> "$PIDS_FILE"

  # Wait for server to be ready
  echo -e "${BLUE}[MLX-Omni]${NC} Waiting for server to be ready..."
  for i in {1..120}; do
    if curl -s "http://localhost:$MLX_OMNI_PORT/anthropic/v1/models" > /dev/null 2>&1; then
      echo -e "${GREEN}[MLX-Omni]${NC} Server is ready! (PID: $MLX_OMNI_PID)"
      return 0
    fi
    sleep 1
    if [ $((i % 30)) -eq 0 ]; then
      echo -e "${BLUE}[MLX-Omni]${NC} Still waiting... ($i/120)"
    fi
  done

  echo -e "${RED}[MLX-Omni]${NC} Server failed to start"
  echo "Check logs: tail -f $LOG_DIR/mlx-omni-server.log"
  exit 1
}

# Start AnyClaude
start_anyclaude() {
  echo ""
  echo -e "${BLUE}[AnyClaude]${NC} Starting AnyClaude...\\n"

  export ANYCLAUDE_MODE=mlx-omni
  export ANYCLAUDE_DEBUG
  export MLX_OMNI_URL="http://localhost:$MLX_OMNI_PORT/anthropic"

  if [ "$PROXY_ONLY" = "true" ]; then
    echo -e "${BLUE}[AnyClaude]${NC} Running in proxy-only mode (no Claude Code spawned)"
    export PROXY_ONLY=true
    "$SCRIPT_DIR/dist/main-cli.js"
  else
    echo -e "${BLUE}[AnyClaude]${NC} Spawning Claude Code with KV cache...\n"
    exec "$SCRIPT_DIR/dist/main-cli.js"
  fi
}

# Show status
show_status() {
  echo ""
  echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
  echo -e "${BLUE}║${NC}     AnyClaude + MLX-Omni with Local Model (KV Cache)     ${BLUE}║${NC}"
  echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
  echo ""
  echo -e "${GREEN}✓${NC} MLX-Omni-Server:   http://localhost:$MLX_OMNI_PORT/anthropic"
  echo -e "${GREEN}✓${NC} Model:             $MLX_MODEL"
  echo -e "${GREEN}✓${NC} AnyClaude Mode:    MLX-Omni"
  echo -e "${GREEN}✓${NC} Debug Level:       $ANYCLAUDE_DEBUG"
  echo -e "${GREEN}✓${NC} KV Cache:          ENABLED (Follow-ups <1s!)"
  if [ "$PROXY_ONLY" = "true" ]; then
    echo -e "${YELLOW}ℹ${NC} Running in proxy-only mode (no Claude Code)"
  else
    echo -e "${GREEN}✓${NC} Claude Code:       Running"
  fi
  echo ""
  echo -e "${BLUE}Logs:${NC}"
  echo "  MLX-Omni:  $LOG_DIR/mlx-omni-server.log"
  echo "  AnyClaude: Check the AnyClaude output above"
  echo ""
  echo -e "${BLUE}Performance:${NC}"
  echo "  1st question: ~30-40s (system prompt + inference)"
  echo "  Follow-ups:   <1s (KV cache hit!)"
  echo ""
  echo -e "${BLUE}Press Ctrl+C to stop both services${NC}"
  echo ""
}

# Main
main() {
  echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
  echo -e "${BLUE}║${NC}     AnyClaude + MLX-Omni Server (Native KV Cache)       ${BLUE}║${NC}"
  echo -e "${BLUE}║${NC}          Anthropic API + 30x Faster Follow-ups          ${BLUE}║${NC}"
  echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
  echo ""

  check_venv_exists
  start_mlx_omni

  if [ "$PROXY_ONLY" = "true" ]; then
    show_status
    wait
  else
    show_status
    start_anyclaude
  fi
}

main "$@"
